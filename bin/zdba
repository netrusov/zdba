#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/zdba'

config = ::ZDBA::Config.new(::ARGV[0])

::ZDBA.logger.level = config[:logger][:level]

if config[:logger][:json]
  ::ZDBA.logger.formatter = proc do |severity, timestamp, _progname, message|
    caller = caller(4..4)[0]
    data = {
      severity:,
      timestamp:,
      caller:,
      message:
    }

    ::JSON.dump(data).concat("\n")
  end
end

config[:require]&.each do |path|
  require path
end

::ZDBA::Manager.new(config).run
